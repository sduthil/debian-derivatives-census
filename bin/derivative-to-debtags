#!/usr/bin/python

# Copyright 2012 Paul Wise
# Released under the MIT/Expat license, see doc/COPYING

# Converts the apt sources.list to a list of Packages/Sources files for the
# debtags server to download and use on debtags.debian.net after aggregation by
# the aggregate-debtags script.
#
# Usage:
# derivative-to-debtags <shortname> <long name file> <sources.list> <apt dir> <debtags file>

import os
import sys
import debian.deb822
import apt_pkg

class Debtags(debian.deb822._multivalued):
	_multivalued_fields = {
		'packages': ['url'],
		'sources': ['url'],
	}

# Init
apt_pkg.init()

# Setup configuration
apt_pkg.config.set('Dir', os.path.abspath(sys.argv[4]))
apt_pkg.config.set('Dir::Etc', os.path.abspath(sys.argv[4]))
apt_pkg.config.set('Dir::State', os.path.abspath(sys.argv[4]))
apt_pkg.config.set('Dir::Cache', os.path.abspath(sys.argv[4]))
apt_pkg.config.set('Dir::State::status', os.path.abspath(os.path.join(sys.argv[4],'status')))
apt_pkg.config.set('Dir::Etc::sourcelist', os.path.abspath(sys.argv[3]))
apt_pkg.config.set('Dir::Bin::gpg', 'fakegpgv')

# Preparation
acquire = apt_pkg.Acquire()
sources_list = apt_pkg.SourceList()
sources_list.read_main_list()
sources_list.get_indexes(acquire, True)

packages = []
sources  = []

for item in acquire.items:
	if 'Sources' in item.desc_uri:
		sources.append(item.desc_uri)
	elif 'Packages' in item.desc_uri:
		packages.append(item.desc_uri)

if packages or sources:

	f = file(sys.argv[2])
	name = f.readline().strip()
	f.close()

	output = Debtags()
	output['Distribution'] = sys.argv[1].strip().split()[0]
	output['Description'] = name
	output['Packages'] = [{'url': package} for package in packages]
	output['Sources'] = [{'url': source} for source in sources]

	f = file(sys.argv[5], 'wb')
	output.dump(f)
	f.close()
