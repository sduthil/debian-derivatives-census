#!/bin/bash
# This script is to be run on snapshot.debian.org only

(
flock -n 666 || exit 0

set -e
umask 0002
mkdir -p ~/tmp
time make -j3 -s -i
cd var
sed -i '/WARNING: unable to download sha1 file, ignoring: Forbidden .*non-free/s/WARNING/INFO/' ./Ordissimo/sources.log
sed -i '/WARNING: unable to download sha1 file, ignoring: 403: .*non-free/s/WARNING/INFO/' ./Ordissimo/sources.log
sed -i '/WARNING: finished processing source package .*: sha1 missing for dsc file/s/WARNING/INFO/' ./Ordissimo/sources.log
grep -C5 WARN ./*/sources.log > sources.log.warnings.tmp
sed -i '/ using scratch space: /s/: [0-9]\+ [0-9]\+ [0-9]\+$//' sources.log.warnings.tmp
diff -u sources.log.warnings sources.log.warnings.tmp || true
mv --force sources.log.warnings.tmp sources.log.warnings
find ~/tmp /tmp -mindepth 1 -user qa | head -n 10 2> /dev/null
find ~/tmp /tmp -mindepth 1 -user qa -delete 2> /dev/null
cd ..
git fetch -q
git status -s
git --no-pager log --branches --not --remotes --simplify-by-decoration --decorate --oneline
git diff HEAD
crontab etc/snapshot.crontab

) 666>~/derivatives-census-lock
